<!doctype html>
<html lang="ru">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width,initial-scale=1"/>
<title>–¢–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ –∑–Ω–∞–Ω–∏–π</title>
<style>
:root{
  --bg:#07101a; --panel: rgba(18,24,33,0.56);
  --accent1:#45a8ff; --accent2:#2aa1ff; --muted:#98a0b3; --text:#e6eef8;
  --danger1:#ff4757; --danger2:#ff3838;
  --card-shadow: 0 12px 30px rgba(2,6,23,0.6);
}
.light{ --bg:#f5f7fb; --panel: rgba(255,255,255,0.92); --text:#081026; --muted:#52606d; --accent1:#2979ff; --accent2:#1e66d7; --danger1:#ff4757; --danger2:#ff3838; }

*{box-sizing:border-box}
html,body{height:100%;margin:0;font-family:-apple-system,BlinkMacSystemFont,"Segoe UI",Roboto,"Helvetica Neue",Arial;color:var(--text);background:linear-gradient(180deg,var(--bg), #061018);-webkit-font-smoothing:antialiased}
.container{max-width:1100px;margin:28px auto;padding:18px}
.header{display:flex;align-items:center;justify-content:space-between;padding:12px;border-radius:14px;background:var(--panel);backdrop-filter:blur(8px);border:1px solid rgba(255,255,255,0.03);box-shadow:var(--card-shadow)}
.title{font-weight:800;font-size:22px}
.subtitle{color:var(--muted);font-size:13px}

.card{margin-top:16px;padding:20px;border-radius:16px;background:linear-gradient(180deg, rgba(255,255,255,0.02), rgba(255,255,255,0.01));border:1px solid rgba(255,255,255,0.03);box-shadow:var(--card-shadow)}
.progress-row{display:flex;align-items:center;gap:12px;margin-bottom:16px}
.progress-small{font-size:13px;color:var(--muted);min-width:180px}
.progress-track{flex:1;height:8px;background:rgba(255,255,255,0.03);border-radius:999px;overflow:hidden}
.progress-bar{height:100%;width:0%;background:linear-gradient(90deg,var(--accent1),var(--accent2));transition:width .35s ease}
.progress-pct{width:48px;text-align:right;color:var(--muted);font-size:13px}

.question{font-size:20px;font-weight:700;margin-bottom:12px;color:var(--text)}
.options{display:flex;flex-direction:column;gap:10px}
.option{display:flex;align-items:center;gap:14px;padding:14px;border-radius:12px;background: linear-gradient(180deg, rgba(255,255,255,0.02), rgba(255,255,255,0.01));border:1px solid rgba(255,255,255,0.04);cursor:pointer;transition:transform .16s ease,box-shadow .16s, background .16s;user-select:none}
.option:hover{transform:translateY(-6px);box-shadow:0 18px 40px rgba(2,6,23,0.55)}
.option .opt-text{flex:1;font-size:15px;color:var(--text)}
.option.selected{background:linear-gradient(90deg,var(--accent1),var(--accent2));color:#fff;border-color:transparent;box-shadow:0 12px 30px rgba(45,166,255,0.14)}
.option.correct{background:linear-gradient(90deg,#2ecc71,#1fbf5b);color:#fff}
.option.incorrect{background:linear-gradient(90deg,#ff6b6b,#ff4b4b);color:#fff}

.meta{display:flex;align-items:center;justify-content:space-between;margin-top:12px}
.feedback{padding:10px 12px;border-radius:10px;display:none;font-weight:700}
.feedback.correct{background:rgba(46,204,113,0.12);color:#2ecc71}
.feedback.incorrect{background:rgba(255,107,107,0.12);color:#ff6b6b}
.explain{margin-left:12px;color:var(--muted);display:none}

.nav{display:flex;align-items:center;gap:12px;justify-content:flex-end;margin-top:18px}
.btn{padding:10px 16px;border-radius:12px;border:none;background:var(--accent1);color:white;font-weight:700;cursor:pointer}
.btn.ghost{background:transparent;border:1px solid rgba(255,255,255,0.04);color:var(--text)}
.btn.danger{background:linear-gradient(90deg,var(--danger1),var(--danger2));color:white;border:none}
.btn.danger:hover{background:linear-gradient(90deg,#ff3838,#ff1e1e)}
.btn:disabled{opacity:0.45;cursor:not-allowed}
.auto-skip-toggle{display:flex;align-items:center;gap:8px;color:var(--muted);font-size:14px;cursor:pointer}
.auto-skip-toggle input{transform:scale(1.12)}

.bottom-cell { margin-top:22px; display:none; }
.bottom-cell.visible { display:block; }
.bottom-cell .track {
  width:100%; height:12px; border-radius:8px; background:rgba(255,255,255,0.03); border:1px solid rgba(255,255,255,0.03); overflow:hidden; position:relative; box-shadow: 0 8px 20px rgba(2,6,23,0.45);
}
.bottom-cell .fill { height:100%; width:0%; background: linear-gradient(90deg,var(--accent1),var(--accent2)); transition: width .05s linear; border-radius:6px; box-shadow:0 6px 16px rgba(45,166,255,0.14); }
.bottom-cell .label { margin-top:8px; text-align:right; color:var(--muted); font-size:13px; }

.results{padding:22px;text-align:center;color:var(--text);display:none}
.score{font-size:36px;font-weight:800;margin-bottom:8px}
.result-details{margin:20px 0;padding:15px;background:rgba(255,255,255,0.02);border-radius:10px;}
.result-details div{margin:5px 0;}

.start-modal{position:fixed;inset:0;background:linear-gradient(rgba(3,6,10,0.6), rgba(3,6,10,0.6));display:flex;align-items:center;justify-content:center;z-index:2000}
.start-card{background:var(--panel);padding:22px;border-radius:14px;border:1px solid rgba(255,255,255,0.04);width:360px;box-shadow:var(--card-shadow);text-align:center}
.mode-btn{width:100%;padding:12px;border-radius:10px;border:none;margin-bottom:10px;font-weight:700;cursor:pointer}
.mode-single{background:linear-gradient(90deg,var(--accent1),var(--accent2));color:white}
.mode-mastery{background:transparent;border:1px solid rgba(255,255,255,0.06);color:var(--text)}
.mode-btn:hover{transform:translateY(-2px);transition:transform 0.2s}

.confirm-modal{position:fixed;inset:0;background:linear-gradient(rgba(3,6,10,0.8), rgba(3,6,10,0.8));display:flex;align-items:center;justify-content:center;z-index:3000;display:none}
.confirm-card{background:var(--panel);padding:22px;border-radius:14px;border:1px solid rgba(255,255,255,0.04);width:360px;box-shadow:var(--card-shadow);text-align:center}
.confirm-buttons{display:flex;gap:10px;margin-top:20px}
.confirm-buttons button{flex:1}

@media(max-width:560px){ .bottom-cell .label{display:none} .bottom-cell .track{height:10px} }
</style>
</head>
<body>
  <div class="container">
    <div class="header">
      <div>
        <div class="title" id="testTitle">–¢–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ –∑–Ω–∞–Ω–∏–π</div>
        <div class="subtitle" id="testSubtitle">–í—ã–±–µ—Ä–∏—Ç–µ —Ä–µ–∂–∏–º —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏—è</div>
      </div>
      <div>
        <button id="themeBtn" style="background:transparent;border:1px solid rgba(255,255,255,0.06);color:var(--text);padding:6px 10px;border-radius:999px;cursor:pointer">–¢–µ–º–∞</button>
      </div>
    </div>

    <div class="card">
      <div class="progress-row">
        <div class="progress-small" id="psmall">–í–æ–ø—Ä–æ—Å 1 –∏–∑ N</div>
        <div class="progress-track"><div id="progressBar" class="progress-bar"></div></div>
        <div class="progress-pct" id="ppct">0%</div>
      </div>

      <div>
        <div class="question" id="qtext">–ó–∞–≥—Ä—É–∑–∫–∞...</div>
        <div class="options" id="options"></div>

        <div class="meta">
          <div id="feedback" class="feedback"></div>
          <div id="explain" class="explain"></div>
        </div>
      </div>

      <div class="nav">
        <button id="prevBtn" class="btn ghost">–ù–∞–∑–∞–¥</button>
        
        <button id="finishBtn" class="btn danger" style="display:none">–ó–∞–≤–µ—Ä—à–∏—Ç—å —Ç–µ—Å—Ç</button>

        <label class="auto-skip-toggle" title="–ï—Å–ª–∏ –≤–∫–ª—é—á–µ–Ω–æ ‚Äî –ø–æ—Å–ª–µ –æ—Ç–≤–µ—Ç–∞ –ø–æ—è–≤–∏—Ç—Å—è –Ω–∏–∂–Ω–∏–π –±–∞—Ä –∏ –∑–∞–ø–æ–ª–Ω–∏—Ç—Å—è –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏">
          <input type="checkbox" id="autoSkip" />
          <span>–ê–≤—Ç–æ–ø—Ä–æ–ø—É—Å–∫</span>
        </label>

        <button id="actionBtn" class="btn">–°–ª–µ–¥—É—é—â–∏–π</button>
      </div>

      <div class="bottom-cell" id="bottomCell" aria-hidden="true">
        <div class="track"><div class="fill" id="bottomFill"></div></div>
        <div class="label" id="bottomLabel">0%</div>
      </div>

      <div id="results" class="results">
        <h2>–¢–µ—Å—Ç –∑–∞–≤–µ—Ä—à—ë–Ω</h2>
        <div class="score" id="finalScore">0/0</div>
        <div id="resultMessage"></div>
        
        <div class="result-details">
          <div>–ü—Ä–∞–≤–∏–ª—å–Ω—ã—Ö –æ—Ç–≤–µ—Ç–æ–≤: <span id="correctAnswers">0</span></div>
          <div>–ù–µ–ø—Ä–∞–≤–∏–ª—å–Ω—ã—Ö –æ—Ç–≤–µ—Ç–æ–≤: <span id="wrongAnswers">0</span></div>
          <div>–ü—Ä–æ—Ü–µ–Ω—Ç –ø—Ä–∞–≤–∏–ª—å–Ω—ã—Ö –æ—Ç–≤–µ—Ç–æ–≤: <span id="percentage">0%</span></div>
          <div>–ü—Ä–æ–π–¥–µ–Ω–æ –≤–æ–ø—Ä–æ—Å–æ–≤: <span id="totalAnswered">0</span></div>
        </div>
        
        <div style="margin-top:14px">
          <button id="restartBtn" class="btn">–ü—Ä–æ–π—Ç–∏ —Å–Ω–æ–≤–∞</button>
        </div>
      </div>
    </div>
  </div>

  <div class="confirm-modal" id="confirmModal">
    <div class="confirm-card">
      <h3>–ó–∞–≤–µ—Ä—à–∏—Ç—å —Ç–µ—Å—Ç?</h3>
      <p>–í—ã —É–≤–µ—Ä–µ–Ω—ã, —á—Ç–æ —Ö–æ—Ç–∏—Ç–µ –∑–∞–≤–µ—Ä—à–∏—Ç—å —Ç–µ—Å—Ç –¥–æ—Å—Ä–æ—á–Ω–æ? –í—Å–µ –æ—Ç–≤–µ—Ç—ã –±—É–¥—É—Ç —Å–æ—Ö—Ä–∞–Ω–µ–Ω—ã.</p>
      <div class="confirm-buttons">
        <button id="confirmCancelBtn" class="btn ghost">–û—Ç–º–µ–Ω–∞</button>
        <button id="confirmFinishBtn" class="btn danger">–ó–∞–≤–µ—Ä—à–∏—Ç—å</button>
      </div>
    </div>
  </div>

  <div class="start-modal" id="startModal">
    <div class="start-card">
      <h2>–í—ã–±–µ—Ä–∏—Ç–µ —Ä–µ–∂–∏–º —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏—è</h2>
      <p style="color:var(--muted);margin-bottom:20px;">–í–æ–ø—Ä–æ—Å—ã –∑–∞–≥—Ä—É–∂–∞—é—Ç—Å—è –∏–∑ —Ñ–∞–π–ª–∞ questions.txt</p>
      <button id="singleBtn" class="mode-btn mode-single">–ü—Ä–æ–π—Ç–∏ –æ–¥–∏–Ω —Ä–∞–∑</button>
      <button id="masteryBtn" class="mode-btn mode-mastery">Mastery ‚Äî –ø–æ–≤—Ç–æ—Ä—è—Ç—å –Ω–µ–≤–µ—Ä–Ω—ã–µ</button>
      <div style="margin-top:20px;padding-top:20px;border-top:1px solid rgba(255,255,255,0.06);text-align:left;">
        <p style="font-size:13px;color:var(--muted);margin:0 0 6px 0;">–§–æ—Ä–º–∞—Ç —Ñ–∞–π–ª–∞ <strong>questions.txt</strong> –¥–æ–ª–∂–µ–Ω –±—ã—Ç—å —Ç–∞–∫–æ–π (–ø—Ä–∏–º–µ—Ä):</p>
        <pre style="font-size:13px;color:var(--muted);background:rgba(0,0,0,0.06);padding:8px;border-radius:6px;">117. –£ –ø–∞—Ü–∏–µ–Ω—Ç–∞ –ø–æ—Å–ª–µ –Ω–æ–∂–µ–≤–æ–≥–æ —Ä–∞–Ω–µ–Ω–∏—è –∑–∞–¥–Ω–µ–π –æ–±–ª–∞—Å—Ç–∏ –≥–æ–ª–µ–Ω–∏ –Ω–∞–±–ª—é–¥–∞–µ—Ç—Å—è...  
[ ] –ó–∞–ø–∏—Ä–∞—Ç–µ–ª—å–Ω—ã–π –Ω–µ—Ä–≤  
[ ] –°–µ–¥–∞–ª–∏—â–Ω—ã–π –Ω–µ—Ä–≤  
[x] –ò–∫—Ä–æ–Ω–æ–∂–Ω—ã–π –Ω–µ—Ä–≤  
[ ] –ü–æ–¥–∫–æ–∂–Ω—ã–π –Ω–µ—Ä–≤  
[ ] –ë–æ–ª—å—à–µ–±–µ—Ä—Ü–æ–≤—ã–π –Ω–µ—Ä–≤

118. –í —Ä–µ–∑—É–ª—å—Ç–∞—Ç–µ –ø–æ–≤—Ä–µ–∂–¥–µ–Ω–∏—è –∫–∞–∫–æ–≥–æ –Ω–µ—Ä–≤–∞...  
[ ] –ü–æ–¥–∫–æ–∂–Ω–æ–≥–æ  
[ ] –ë–æ–ª—å—à–µ–±–µ—Ä—Ü–æ–≤–æ–≥–æ  
[ ] –ë–µ–¥—Ä–µ–Ω–Ω–æ–≥–æ  
[x] –°–µ–¥–∞–ª–∏—â–Ω–æ–≥–æ  
[ ] –ó–∞–ø–∏—Ä–∞—Ç–µ–ª—å–Ω–æ–≥–æ</pre>
        <p style="font-size:12px;color:var(--muted);margin-top:8px;">–í–∞—Ä–∏–∞–Ω—Ç —Å—á–∏—Ç–∞–µ—Ç—Å—è –ø—Ä–∞–≤–∏–ª—å–Ω—ã–º –µ—Å–ª–∏ –≤–Ω—É—Ç—Ä–∏ –∫–≤–∞–¥—Ä–∞—Ç–Ω—ã—Ö —Å–∫–æ–±–æ–∫ —Å—Ç–æ–∏—Ç <code>x</code> –∏–ª–∏ —Ä—É—Å—Å–∫–∞—è <code>—Ö</code>. –ü–æ–¥–¥–µ—Ä–∂–∏–≤–∞—é—Ç—Å—è –Ω–µ—Å–∫–æ–ª—å–∫–æ –ø—Ä–∞–≤–∏–ª—å–Ω—ã—Ö –æ—Ç–≤–µ—Ç–æ–≤ (–Ω–µ—Å–∫–æ–ª—å–∫–æ –ø–æ–º–µ—Ç–æ–∫ [x]).</p>
      </div>
    </div>
  </div>

<script>
// ====== –ì–õ–û–ë–ê–õ–ù–´–ï –ü–ï–†–ï–ú–ï–ù–ù–´–ï ======
let mode = 'single';
let currentQuestions = [];
let order = [];
let currentIndex = 0;
let score = 0;
let answered = false;
let userSelections = {};
let totalQuestionsInTest = 0;
let questionsAnswered = 0;

let bottomAnim = null;
let bottomStart = null;
let bottomDuration = 0;
let bottomActive = false;

// ====== –°–û–•–†–ê–ù–ï–ù–ò–ï –°–û–°–¢–û–Ø–ù–ò–Ø –í LOCALSTORAGE ======
function saveState() {
  const state = {
    mode,
    order,
    currentIndex,
    score,
    answered,
    userSelections,
    totalQuestionsInTest,
    questionsAnswered
  };
  localStorage.setItem('testState', JSON.stringify(state));
}

function loadState() {
  const saved = localStorage.getItem('testState');
  if (saved) {
    try {
      return JSON.parse(saved);
    } catch (e) {
      console.error('–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ —Å–æ—Å—Ç–æ—è–Ω–∏—è:', e);
      return null;
    }
  }
  return null;
}

function clearState() {
  localStorage.removeItem('testState');
}

// ====== –í–°–ü–û–ú–û–ì–ê–¢–ï–õ–¨–ù–´–ï –§–£–ù–ö–¶–ò–ò ======
function shuffleInPlace(a){ 
  for(let i = a.length - 1; i > 0; i--){
    const j = Math.floor(Math.random() * (i + 1));
    [a[i], a[j]] = [a[j], a[i]];
  } 
  return a; 
}

function shuffled(a){ 
  return shuffleInPlace(a.slice()); 
}

function isMulti(q){ 
  return Array.isArray(q.correctAnswers) && q.correctAnswers.length > 1; 
}

// ====== –≠–õ–ï–ú–ï–ù–¢–´ DOM ======
const qtext = document.getElementById('qtext');
const optionsEl = document.getElementById('options');
const prevBtn = document.getElementById('prevBtn');
const actionBtn = document.getElementById('actionBtn');
const finishBtn = document.getElementById('finishBtn');
const progressBar = document.getElementById('progressBar');
const psmall = document.getElementById('psmall');
const ppct = document.getElementById('ppct');
const feedbackEl = document.getElementById('feedback');
const explainEl = document.getElementById('explain');
const resultsEl = document.getElementById('results');
const finalScore = document.getElementById('finalScore');
const resultMessage = document.getElementById('resultMessage');
const correctAnswersEl = document.getElementById('correctAnswers');
const wrongAnswersEl = document.getElementById('wrongAnswers');
const percentageEl = document.getElementById('percentage');
const totalAnsweredEl = document.getElementById('totalAnswered');
const startModal = document.getElementById('startModal');
const singleBtn = document.getElementById('singleBtn');
const masteryBtn = document.getElementById('masteryBtn');
const autoSkipEl = document.getElementById('autoSkip');
const bottomCell = document.getElementById('bottomCell');
const bottomFill = document.getElementById('bottomFill');
const bottomLabel = document.getElementById('bottomLabel');
const restartBtn = document.getElementById('restartBtn');
const themeBtn = document.getElementById('themeBtn');
const testTitle = document.getElementById('testTitle');
const testSubtitle = document.getElementById('testSubtitle');
const confirmModal = document.getElementById('confirmModal');
const confirmCancelBtn = document.getElementById('confirmCancelBtn');
const confirmFinishBtn = document.getElementById('confirmFinishBtn');

// ====== –ó–ê–ì–†–£–ó–ö–ê –í–û–ü–†–û–°–û–í –ò–ó –§–ê–ô–õ–ê ======
async function loadQuestionsFromFile() {
  try {
    const response = await fetch('questions.txt');
    if (!response.ok) {
      throw new Error('–ù–µ —É–¥–∞–ª–æ—Å—å –∑–∞–≥—Ä—É–∑–∏—Ç—å —Ñ–∞–π–ª questions.txt');
    }
    const text = await response.text();
    return parseQuestions(text);
  } catch (error) {
    console.error('–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –≤–æ–ø—Ä–æ—Å–æ–≤:', error);
    alert('–ù–µ —É–¥–∞–ª–æ—Å—å –∑–∞–≥—Ä—É–∑–∏—Ç—å –≤–æ–ø—Ä–æ—Å—ã –∏–∑ —Ñ–∞–π–ª–∞ questions.txt. –ü—Ä–æ–≤–µ—Ä—å—Ç–µ –Ω–∞–ª–∏—á–∏–µ —Ñ–∞–π–ª–∞ –∏ —Ñ–æ—Ä–º–∞—Ç.');
    return createFallbackQuestions();
  }
}

/*
  –ù–æ–≤—ã–π –ø–∞—Ä—Å–µ—Ä: —á–∏—Ç–∞–µ—Ç –±–ª–æ–∫–∏, –Ω–∞—á–∏–Ω–∞—é—â–∏–µ—Å—è —Å "–Ω–æ–º–µ—Ä. " (–Ω–∞–ø—Ä–∏–º–µ—Ä "117. ..."),
  –∑–∞—Ç–µ–º –≤–Ω—É—Ç—Ä–∏ –±–ª–æ–∫–∞ –∏—â–µ—Ç —Å—Ç—Ä–æ–∫–∏-–æ–ø—Ü–∏–∏ —Ñ–æ—Ä–º–∞—Ç–∞:
    [ ] –¢–µ–∫—Å—Ç –≤–∞—Ä–∏–∞–Ω—Ç–∞
    [x] –ü—Ä–∞–≤–∏–ª—å–Ω—ã–π –≤–∞—Ä–∏–∞–Ω—Ç    (–ø–æ–¥–¥–µ—Ä–∂–∏–≤–∞—é—Ç—Å—è –ª–∞—Ç–∏–Ω—Å–∫–∏–π x/X –∏ —Ä—É—Å—Å–∫–∞—è —Ö/–•)
  –í—Å—ë, —á—Ç–æ –¥–æ –ø–µ—Ä–≤–æ–π –æ–ø—Ü–∏–∏ ‚Äî —Å—á–∏—Ç–∞–µ—Ç—Å—è —Ç–µ–∫—Å—Ç–æ–º –≤–æ–ø—Ä–æ—Å–∞ (–ø–æ–¥–¥–µ—Ä–∂–∏–≤–∞–µ—Ç—Å—è –º–Ω–æ–≥–æ—Å—Ç—Ä–æ—á–Ω—ã–π –≤–æ–ø—Ä–æ—Å).
  –ï—Å–ª–∏ –≤ –±–ª–æ–∫–µ –Ω–µ—Ç –æ–ø—Ü–∏–π ‚Äî –±–ª–æ–∫ –∏–≥–Ω–æ—Ä–∏—Ä—É–µ—Ç—Å—è.
*/
function parseQuestions(text) {
  if (!text) return createFallbackQuestions();
  // –ù–æ—Ä–º–∞–ª–∏–∑—É–µ–º –ø–µ—Ä–µ–Ω–æ—Å—ã —Å—Ç—Ä–æ–∫
  const normalized = text.replace(/\r\n/g, '\n').replace(/\r/g, '\n');
  const questionBlocks = [];
  // –†–µ–≥–µ–∫—Å: –Ω–∞—Ö–æ–¥–∏—Ç –±–ª–æ–∫ –Ω–∞—á–∏–Ω–∞—è —Å "—á–∏—Å–ª–æ." –¥–æ —Å–ª–µ–¥—É—é—â–µ–≥–æ "—á–∏—Å–ª–æ." –∏–ª–∏ –∫–æ–Ω—Ü–∞ —Ç–µ–∫—Å—Ç–∞
  const blockRegex = /^(\d+\.\s[\s\S]*?)(?=^\d+\.|\s*$)/gim;
  let m;
  while ((m = blockRegex.exec(normalized)) !== null) {
    questionBlocks.push(m[1].trim());
  }

  const questions = [];
  for (let i = 0; i < questionBlocks.length; i++) {
    const block = questionBlocks[i];
    const lines = block.split('\n').map(l => l.replace(/\u00A0/g, ' ').trim());
    if (lines.length === 0) continue;

    // –ü–µ—Ä–≤—ã–π —à–∞–≥ ‚Äî —Å–æ–±—Ä–∞—Ç—å –æ–ø—Ü–∏–∏ –∏ –Ω–∞–π—Ç–∏ –∏–Ω–¥–µ–∫—Å –ø–µ—Ä–≤–æ–π –æ–ø—Ü–∏–∏
    const optionPattern = /^\[\s*([xX—Ö–•]?)\s*\]\s*(.*)$/; // –∑–∞—Ö–≤–∞—Ç—ã–≤–∞–µ—Ç –º–µ—Ç–∫—É (x –∏–ª–∏ —Ö) –∏ —Ç–µ–∫—Å—Ç –≤–∞—Ä–∏–∞–Ω—Ç–∞
    const options = [];
    const correctFlags = [];
    let firstOptionIndex = -1;
    for (let li = 0; li < lines.length; li++) {
      const line = lines[li];
      const optMatch = line.match(optionPattern);
      if (optMatch) {
        if (firstOptionIndex === -1) firstOptionIndex = li;
        const mark = optMatch[1];
        const txt = optMatch[2].trim();
        options.push(txt);
        correctFlags.push( /[xX—Ö–•]/.test(mark) );
      }
    }

    if (options.length === 0) continue; // –±–ª–æ–∫ –±–µ–∑ –æ–ø—Ü–∏–π ‚Äî –ø—Ä–æ–ø—É—Å–∫–∞–µ–º

    // –í–æ–ø—Ä–æ—Å ‚Äî —ç—Ç–æ –≤—Å—ë, —á—Ç–æ –∏–¥—ë—Ç –¥–æ –ø–µ—Ä–≤–æ–π –æ–ø—Ü–∏–∏ (–∏–ª–∏ –ø–µ—Ä–≤—ã–π —ç–ª–µ–º–µ–Ω—Ç —Å—Ç—Ä–æ–∫, –æ–±—Ä–µ–∑–∞–Ω–Ω—ã–π –Ω–æ–º–µ—Ä–∞)
    let questionLines = [];
    if (firstOptionIndex > 0) {
      questionLines = lines.slice(0, firstOptionIndex);
    } else {
      // –µ—Å–ª–∏ –æ–ø—Ü–∏—è —Å—Ä–∞–∑—É –Ω–∞ —Å–ª–µ–¥—É—é—â–µ–π —Å—Ç—Ä–æ–∫–µ, –≤—Å—ë —Ä–∞–≤–Ω–æ –±–µ—Ä–µ–º –ø–µ—Ä–≤—ã–µ —Å—Ç—Ä–æ–∫–∏ –∫—Ä–æ–º–µ –æ–ø—Ü–∏–π
      questionLines = lines.filter((ln, idx) => !ln.match(optionPattern)).slice(0, 1);
    }

    // –°–æ–±–∏—Ä–∞–µ–º —Ç–µ–∫—Å—Ç –≤–æ–ø—Ä–æ—Å–∞ –∏ —É–¥–∞–ª—è–µ–º –ø—Ä–µ—Ñ–∏–∫—Å "117. "
    const rawQuestion = questionLines.join(' ').replace(/^\d+\.\s*/, '').trim();

    // correctAnswers ‚Äî –∏–Ω–¥–µ–∫—Å—ã –≤–∞—Ä–∏–∞–Ω—Ç–æ–≤ –≤ –∏—Å—Ö–æ–¥–Ω–æ–º –ø–æ—Ä—è–¥–∫–µ (0-based)
    const correctAnswers = [];
    for (let k = 0; k < correctFlags.length; k++) {
      if (correctFlags[k]) correctAnswers.push(k);
    }

    questions.push({
      question: rawQuestion || ('–í–æ–ø—Ä–æ—Å ' + (questions.length + 1)),
      questionNumber: (() => {
        const numMatch = block.match(/^\s*(\d+)\./);
        return numMatch ? parseInt(numMatch[1], 10) : (questions.length + 1);
      })(),
      options,
      correctAnswers,
      explanation: ''
    });
  }

  if (questions.length === 0) {
    return createFallbackQuestions();
  }
  return questions;
}

function createFallbackQuestions() {
  return [
    {
      question: "–ß—Ç–æ —Ç–∞–∫–æ–µ JavaScript?",
      questionNumber: 1,
      options: [
        "–Ø–∑—ã–∫ –ø—Ä–æ–≥—Ä–∞–º–º–∏—Ä–æ–≤–∞–Ω–∏—è –¥–ª—è –≤–µ–±-—Ä–∞–∑—Ä–∞–±–æ—Ç–∫–∏",
        "–ë–∞–∑–∞ –¥–∞–Ω–Ω—ã—Ö",
        "–ì—Ä–∞—Ñ–∏—á–µ—Å–∫–∏–π —Ä–µ–¥–∞–∫—Ç–æ—Ä",
        "–û–ø–µ—Ä–∞—Ü–∏–æ–Ω–Ω–∞—è —Å–∏—Å—Ç–µ–º–∞"
      ],
      correctAnswers: [0],
      explanation: "JavaScript - —ç—Ç–æ —è–∑—ã–∫ –ø—Ä–æ–≥—Ä–∞–º–º–∏—Ä–æ–≤–∞–Ω–∏—è, –∏—Å–ø–æ–ª—å–∑—É–µ–º—ã–π –¥–ª—è —Å–æ–∑–¥–∞–Ω–∏—è –∏–Ω—Ç–µ—Ä–∞–∫—Ç–∏–≤–Ω—ã—Ö –≤–µ–±-—Å—Ç—Ä–∞–Ω–∏—Ü."
    },
    {
      question: "–ß—Ç–æ —Ç–∞–∫–æ–µ HTML?",
      questionNumber: 2,
      options: [
        "–Ø–∑—ã–∫ —Ä–∞–∑–º–µ—Ç–∫–∏ –≥–∏–ø–µ—Ä—Ç–µ–∫—Å—Ç–∞",
        "–Ø–∑—ã–∫ –ø—Ä–æ–≥—Ä–∞–º–º–∏—Ä–æ–≤–∞–Ω–∏—è",
        "–°–∏—Å—Ç–µ–º–∞ —É–ø—Ä–∞–≤–ª–µ–Ω–∏—è –±–∞–∑–∞–º–∏ –¥–∞–Ω–Ω—ã—Ö",
        "–§—Ä–µ–π–º–≤–æ—Ä–∫ –¥–ª—è CSS"
      ],
      correctAnswers: [0],
      explanation: "HTML (HyperText Markup Language) - —Å—Ç–∞–Ω–¥–∞—Ä—Ç–Ω—ã–π —è–∑—ã–∫ —Ä–∞–∑–º–µ—Ç–∫–∏ –¥–æ–∫—É–º–µ–Ω—Ç–æ–≤ –¥–ª—è –≤–µ–±-—Å—Ç—Ä–∞–Ω–∏—Ü."
    }
  ];
}

// ====== –ù–ò–ñ–ù–ò–ô –ü–†–û–ì–†–ï–°–°-–ë–ê–† ======
function startBottomFill(ms){
  if (!autoSkipEl || !autoSkipEl.checked) return;
  if (bottomActive) return;
  
  bottomActive = true;
  bottomDuration = ms;
  bottomStart = null;
  bottomFill.style.width = '0%';
  bottomLabel.textContent = '0%';
  bottomCell.style.display = 'block';
  bottomCell.classList.add('visible');

  function step(ts){
    if (!bottomStart) bottomStart = ts;
    const elapsed = ts - bottomStart;
    const pct = Math.min(1, elapsed / bottomDuration);
    const pctInt = Math.round(pct * 100);
    bottomFill.style.width = pctInt + '%';
    bottomLabel.textContent = pctInt + '%';
    
    if (pct < 1){
      bottomAnim = requestAnimationFrame(step);
    } else {
      bottomAnim = null;
      bottomActive = false;
      if (autoSkipEl && autoSkipEl.checked){
        proceedToNext(true);
      }
    }
  }
  
  bottomAnim = requestAnimationFrame(step);
}

function stopBottomFill(){
  if (bottomAnim){ 
    cancelAnimationFrame(bottomAnim); 
    bottomAnim = null; 
  }
  bottomStart = null;
  bottomDuration = 0;
  bottomActive = false;
  bottomCell.classList.remove('visible');
  
  clearTimeout(bottomCell._hideTimeout);
  bottomCell._hideTimeout = setTimeout(() => {
    bottomCell.style.display = 'none';
    bottomFill.style.width = '0%';
    bottomLabel.textContent = '0%';
  }, 160);
}

function cancelBottomIfRunning(){
  stopBottomFill();
}

// ====== –°–ï–°–°–ò–Ø –ò –û–¢–û–ë–†–ê–ñ–ï–ù–ò–ï ======
async function startSession(selectedMode, savedState = null) {
  mode = selectedMode;
  startModal.style.display = 'none';
  
  qtext.textContent = '–ó–∞–≥—Ä—É–∑–∫–∞ –≤–æ–ø—Ä–æ—Å–æ–≤...';
  optionsEl.innerHTML = '';
  actionBtn.disabled = true;
  finishBtn.style.display = 'inline-block';
  
  currentQuestions = await loadQuestionsFromFile();
  
  if (!currentQuestions || currentQuestions.length === 0) {
    alert('–ù–µ —É–¥–∞–ª–æ—Å—å –∑–∞–≥—Ä—É–∑–∏—Ç—å –≤–æ–ø—Ä–æ—Å—ã. –ü—Ä–æ–≤–µ—Ä—å—Ç–µ —Ñ–∞–π–ª questions.txt');
    showModeSelection();
    return;
  }
  
  testTitle.textContent = '–¢–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ –∑–Ω–∞–Ω–∏–π';
  testSubtitle.textContent = `–†–µ–∂–∏–º: ${mode === 'single' ? '–û–¥–∏–Ω —Ä–∞–∑' : 'Mastery'}`;
  
  if (savedState) {
    order = savedState.order;
    currentIndex = savedState.currentIndex;
    score = savedState.score;
    answered = savedState.answered;
    userSelections = savedState.userSelections;
    totalQuestionsInTest = savedState.totalQuestionsInTest;
    questionsAnswered = savedState.questionsAnswered;
  } else {
    order = shuffled(Array.from({length: currentQuestions.length}, (_, i) => i));
    currentIndex = 0;
    score = 0;
    answered = false;
    userSelections = {};
    totalQuestionsInTest = currentQuestions.length;
    questionsAnswered = 0;
  }
  
  renderCurrent();
  saveState();
}

function renderCurrent(){
  if (currentIndex >= order.length){ 
    showResults(); 
    return; 
  }
  
  const qidx = order[currentIndex];
  const q = currentQuestions[qidx];

  answered = false;
  feedbackEl.style.display = 'none';
  explainEl.style.display = 'none';
  optionsEl.innerHTML = '';
  actionBtn.disabled = true;
  
  if (mode === 'single' && currentIndex === order.length - 1) {
    actionBtn.textContent = '–ó–∞–≤–µ—Ä—à–∏—Ç—å —Ç–µ—Å—Ç';
  } else {
    actionBtn.textContent = '–°–ª–µ–¥—É—é—â–∏–π';
  }

  const questionNumber = q.questionNumber || (currentIndex + 1);
  psmall.textContent = `–í–æ–ø—Ä–æ—Å ${questionNumber} –∏–∑ ${totalQuestionsInTest}`;
  const pct = Math.round(((currentIndex + 1) / order.length) * 100);
  progressBar.style.width = pct + '%';
  ppct.textContent = pct + '%';

  qtext.textContent = q ? q.question : '–í–æ–ø—Ä–æ—Å–æ–≤ –Ω–µ—Ç';
  if (!q) { 
    optionsEl.innerHTML = '<div style="color:var(--muted);padding:12px;border-radius:8px;background:rgba(255,255,255,0.02)">–í–æ–ø—Ä–æ—Å –Ω–µ –Ω–∞–π–¥–µ–Ω.</div>'; 
    prevBtn.disabled = true; 
    actionBtn.disabled = true; 
    return; 
  }

  const multi = isMulti(q);
  let pairs = q.options.map((t, i) => ({t, orig: i}));
  shuffleInPlace(pairs);

  pairs.forEach(pair => {
    const label = document.createElement('label');
    label.className = 'option';
    const input = document.createElement('input');
    input.type = multi ? 'checkbox' : 'radio';
    input.name = 'opt' + qidx;
    input.dataset.orig = String(pair.orig);
    const span = document.createElement('span'); 
    span.className = 'opt-text'; 
    span.textContent = pair.t;
    label.appendChild(input); 
    label.appendChild(span);
    optionsEl.appendChild(label);

    if (!multi){
      label.addEventListener('click', () => {
        if (answered) return;
        const chosen = Number(input.dataset.orig);
        userSelections[qidx] = [chosen];
        evaluateSingle(qidx, chosen);
      });
    }
  });

  if (multi){
    actionBtn.textContent = '–ü—Ä–æ–¥–æ–ª–∂–∏—Ç—å';
    actionBtn.disabled = true;
    optionsEl.querySelectorAll('input').forEach(inp => inp.addEventListener('change', () => {
      actionBtn.disabled = optionsEl.querySelectorAll('input:checked').length === 0;
    }));
  } else {
    actionBtn.disabled = true;
  }

  prevBtn.disabled = currentIndex === 0;

  if (!(autoSkipEl && autoSkipEl.checked) && !bottomActive){
    bottomCell.style.display = 'none';
    bottomFill.style.width = '0%';
    bottomLabel.textContent = '0%';
  }
  
  saveState();
}

// ====== –ü–†–û–í–ï–†–ö–ê –û–¢–í–ï–¢–û–í ======
function evaluateSingle(qidx, chosenOrig){
  const q = currentQuestions[qidx];
  const correct = q.correctAnswers.includes(chosenOrig);

  optionsEl.querySelectorAll('.option').forEach(label => {
    label.style.pointerEvents = 'none';
    const orig = Number(label.querySelector('input').dataset.orig);
    label.classList.remove('correct','incorrect','selected');
    if (q.correctAnswers.includes(orig)) label.classList.add('correct');
    if (orig === chosenOrig && !correct) label.classList.add('incorrect');
    if (orig === chosenOrig) label.classList.add('selected');
  });

  feedbackEl.textContent = correct ? '‚úì –ü—Ä–∞–≤–∏–ª—å–Ω–æ' : '‚úó –ù–µ–ø—Ä–∞–≤–∏–ª—å–Ω–æ';
  feedbackEl.className = 'feedback ' + (correct ? 'correct' : 'incorrect');
  feedbackEl.style.display = 'block';
  
  if (q.explanation){ 
    explainEl.textContent = q.explanation; 
    explainEl.style.display = 'block'; 
  }

  if (correct) score++;
  answered = true;
  questionsAnswered++;
  actionBtn.disabled = false;

  if (autoSkipEl && autoSkipEl.checked){
    startBottomFill(3000);
  } else {
    if (!bottomActive) stopBottomFill();
  }
  
  saveState();
}

function evaluateMulti(qidx){
  const q = currentQuestions[qidx];
  const chosen = Array.from(optionsEl.querySelectorAll('input:checked')).map(i => Number(i.dataset.orig)).sort((a,b) => a-b);
  userSelections[qidx] = chosen.slice();
  const corr = q.correctAnswers.slice().sort((a,b) => a-b);
  const full = JSON.stringify(chosen) === JSON.stringify(corr);

  optionsEl.querySelectorAll('.option').forEach(label => {
    label.style.pointerEvents = 'none';
    const orig = Number(label.querySelector('input').dataset.orig);
    label.classList.remove('correct','incorrect','selected');
    if (corr.includes(orig)) label.classList.add('correct');
    if (chosen.includes(orig) && !corr.includes(orig)) label.classList.add('incorrect');
    if (chosen.includes(orig)) label.classList.add('selected');
  });

  feedbackEl.textContent = full ? '‚úì –ü–æ–ª–Ω–æ—Å—Ç—å—é –ø—Ä–∞–≤–∏–ª—å–Ω–æ' : '‚úó –ù–µ–ø—Ä–∞–≤–∏–ª—å–Ω–æ';
  feedbackEl.className = 'feedback ' + (full ? 'correct' : 'incorrect');
  feedbackEl.style.display = 'block';
  
  if (q.explanation){ 
    explainEl.textContent = q.explanation; 
    explainEl.style.display = 'block'; 
  }

  if (full) score++;
  answered = true;
  questionsAnswered++;
  actionBtn.disabled = false;

  if (autoSkipEl && autoSkipEl.checked){
    startBottomFill(4500);
  } else {
    if (!bottomActive) stopBottomFill();
  }
  
  saveState();
}

// ====== –ü–ï–†–ï–•–û–î –ö –°–õ–ï–î–£–Æ–©–ï–ú–£ ======
function proceedToNext(isAuto){
  if (!isAuto){
    if (bottomActive) cancelBottomIfRunning();
  }

  if (currentIndex >= order.length) return;
  const qidx = order[currentIndex];
  const q = currentQuestions[qidx];

  if (isMulti(q) && !answered){
    evaluateMulti(qidx);
    return;
  }
  if (!isMulti(q) && !answered) return;

  let wasCorrect = false;
  if (isMulti(q)){
    const chosen = (userSelections[qidx] || []).slice().sort((a,b) => a-b);
    const corr = q.correctAnswers.slice().sort((a,b) => a-b);
    wasCorrect = JSON.stringify(chosen) === JSON.stringify(corr);
  } else {
    wasCorrect = q.correctAnswers.includes((userSelections[qidx] || [])[0]);
  }

  if (mode === 'mastery' && !wasCorrect){
    const gap = Math.floor(Math.random() * 3) + 5;
    const insertPos = Math.min(currentIndex + gap, order.length);
    order.splice(insertPos, 0, qidx);
  }

  currentIndex++;

  if (currentIndex >= order.length){ 
    showResults(); 
    return; 
  }
  
  renderCurrent();
}

// ====== –†–ï–ó–£–õ–¨–¢–ê–¢–´ ======
function showResults(){
  document.querySelector('.card').style.display = 'none';
  resultsEl.style.display = 'block';
  finalScore.textContent = `${score} / ${totalQuestionsInTest}`;
  
  const wrongAnswers = questionsAnswered - score;
  const percentage = totalQuestionsInTest > 0 ? Math.round((score / totalQuestionsInTest) * 100) : 0;
  
  correctAnswersEl.textContent = score;
  wrongAnswersEl.textContent = wrongAnswers;
  percentageEl.textContent = percentage + '%';
  totalAnsweredEl.textContent = questionsAnswered + ' –∏–∑ ' + totalQuestionsInTest;
  
  let message = '';
  if (percentage >= 90) message = '–û—Ç–ª–∏—á–Ω—ã–π —Ä–µ–∑—É–ª—å—Ç–∞—Ç! üéâ';
  else if (percentage >= 70) message = '–•–æ—Ä–æ—à–∏–π —Ä–µ–∑—É–ª—å—Ç–∞—Ç! üëç';
  else if (percentage >= 50) message = '–£–¥–æ–≤–ª–µ—Ç–≤–æ—Ä–∏—Ç–µ–ª—å–Ω–æ. üìö';
  else message = '–ù—É–∂–Ω–æ –ø–æ—Ä–∞–±–æ—Ç–∞—Ç—å. üí™';
  
  resultMessage.textContent = message;
  
  clearState();
}

function showConfirmFinishModal() {
  confirmModal.style.display = 'flex';
}

function hideConfirmFinishModal() {
  confirmModal.style.display = 'none';
}

function finishTest() {
  hideConfirmFinishModal();
  showModeSelection();
}

function showModeSelection(){
  resultsEl.style.display = 'none';
  document.querySelector('.card').style.display = 'block';
  finishBtn.style.display = 'none';
  
  testTitle.textContent = '–¢–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ –∑–Ω–∞–Ω–∏–π';
  testSubtitle.textContent = '–í—ã–±–µ—Ä–∏—Ç–µ —Ä–µ–∂–∏–º —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏—è';
  
  startModal.style.display = 'flex';
  
  clearState();
}

// ====== –í–û–°–°–¢–ê–ù–û–í–õ–ï–ù–ò–ï –°–ï–°–°–ò–ò –ü–†–ò –ó–ê–ì–†–£–ó–ö–ï ======
function checkSavedSession() {
  const savedState = loadState();
  if (savedState) {
    const continueTest = confirm('–û–±–Ω–∞—Ä—É–∂–µ–Ω–∞ –Ω–µ–∑–∞–≤–µ—Ä—à–µ–Ω–Ω–∞—è —Å–µ—Å—Å–∏—è —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏—è. –•–æ—Ç–∏—Ç–µ –ø—Ä–æ–¥–æ–ª–∂–∏—Ç—å?');
    if (continueTest) {
      startSession(savedState.mode, savedState);
      return true;
    } else {
      clearState();
    }
  }
  return false;
}

// ====== –û–ë–†–ê–ë–û–¢–ß–ò–ö–ò –°–û–ë–´–¢–ò–ô ======
actionBtn.addEventListener('click', () => {
  if (currentIndex === order.length - 1 && mode === 'single') {
    finishTest();
  } else {
    proceedToNext(false);
  }
});

prevBtn.addEventListener('click', () => { 
  if (bottomActive) cancelBottomIfRunning(); 
  if (currentIndex > 0){ 
    currentIndex--; 
    renderCurrent(); 
  } 
});

finishBtn.addEventListener('click', showConfirmFinishModal);

confirmCancelBtn.addEventListener('click', hideConfirmFinishModal);
confirmFinishBtn.addEventListener('click', finishTest);

autoSkipEl.addEventListener('change', () => {
  if (!autoSkipEl.checked && bottomActive){
    stopBottomFill();
  }
});

singleBtn.addEventListener('click', () => startSession('single'));
masteryBtn.addEventListener('click', () => startSession('mastery'));

restartBtn.addEventListener('click', showModeSelection);

themeBtn.addEventListener('click', () => document.documentElement.classList.toggle('light'));

document.addEventListener('keydown', (e) => { 
  if (e.key === 'Enter') proceedToNext(false); 
});

document.addEventListener('keydown', function(e) {
  if (e.key === 'F5' || (e.ctrlKey && e.key === 'r')) {
    e.preventDefault();
  }
});

window.addEventListener('beforeunload', function (e) {
  if (currentQuestions.length > 0) {
    e.preventDefault();
    e.returnValue = '–í—ã –ø—Ä–æ—Ö–æ–¥–∏—Ç–µ —Ç–µ—Å—Ç. –í—Å–µ –Ω–µ—Å–æ—Ö—Ä–∞–Ω–µ–Ω–Ω—ã–µ –¥–∞–Ω–Ω—ã–µ –±—É–¥—É—Ç –ø–æ—Ç–µ—Ä—è–Ω—ã. –í—ã —É–≤–µ—Ä–µ–Ω—ã, —á—Ç–æ —Ö–æ—Ç–∏—Ç–µ –ø–æ–∫–∏–Ω—É—Ç—å —Å—Ç—Ä–∞–Ω–∏—Ü—É?';
  }
});

// ====== –ò–ù–ò–¶–ò–ê–õ–ò–ó–ê–¶–ò–Ø ======
function init() {
  const hasSavedSession = checkSavedSession();
  
  if (!hasSavedSession && startModal) {
    startModal.style.display = 'flex';
  }
}

document.addEventListener('DOMContentLoaded', init);
</script>
</body>
</html>
